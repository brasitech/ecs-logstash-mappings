# Corelight ECS Logstash Pipeline
# Git Repository: https://github.com/corelight/ecs-logstash-mappings
# Authors: Corelight Inc, Brasi Tech LLC
# License: BSD 3-Clause
# Support: https://github.com/corelight/ecs-logstash-mappings/issues/new
# Releases: https://github.com/corelight/ecs-logstash-mappings/releases

# network.transport is common across many of the logs with only a few variations. Thus handle them all in one config
filter {
  if [@metadata][z_no_reuse][event_type] == "corelight" {
    # may already be set via 'proto' (which is the common across many of the logs, thus let's get into the few variations)
    if ![network][transport] {
        # UDP
        if [event][dataset] in [ "dhcp", "gquic", "ntp", "radius", "sip", "snmp" ] {
          mutate {
            add_field => {
              "[network][transport]" => "udp"
              "[@metadata][etl][pipeline]" => "filter-mutate-dd83077e3a00-20220310.01"
            }
            tag_on_failure => "_mutate_error-dd83077e3a00-20220310.01"
            id => "filter-mutate-dd83077e3a00"
          }
        }
        # TCP
        else if [event][dataset] in [ "dce_rpc", "ftp", "irc", "kerberos", "mqtt_connect", "mqtt_publish", "mqtt_subscribe", "mqtt", "ntlm", "pop3", "rfb", "sip", "smb_files", "smb_mapping", "smtp", "snmp", "socks", "ssh", "stepping" ] {
          mutate {
            add_field => {
              "[network][transport]" => "tcp"
              "[@metadata][etl][pipeline]" => "filter-mutate-98d5e7b74d51-20220310.01"
            }
            tag_on_failure => "_mutate_error-98d5e7b74d51-20220310.01"
            id => "filter-mutate-98d5e7b74d51"
          }
        }
    }
  }
}
