# Corelight ECS Logstash Pipeline
# Git Repository: https://github.com/corelight/ecs-logstash-mappings
# Authors: Corelight Inc, Brasi Tech LLC
# License: BSD 3-Clause
# Support: https://github.com/corelight/ecs-logstash-mappings/issues/new
# Releases: https://github.com/corelight/ecs-logstash-mappings/releases

filter {
  if [@metadata][z_no_reuse][event_type] == "corelight" and [@metadata][z_no_reuse][event_sub_type] == "suricata_corelight" {
    mutate {
      update => {
        "[@metadata][temporary_metadata_index_name_suffix]" => "suricata"
        "[event][category]" => [ "detection", "network" ]
      }
      rename => {
        "alert.signature" => "[rule][name]"
        "event.severity" => "[alert][severity]"
        "metadata" => "[suricata][metadata]"
        "pcap_cnt" => "[suricata][pcap_count]"
        "rule.action" => "[rule][alert]"
        "rule.category" => "[rule][category]"
        "rule.gid" => "[rule][gid]"
        "rule.id" => "[alert][signature_id]"
        "rule.version" => "[rule][rev]"
        "service" => "[network][protocol]"
      }
      # convert so can do actually if conditional checks on true/false value itself (versus bool field exists that it bugs to) without unnecessary logstash logic
      convert => {
        "[log][id][tx_id]" => "string"
      }
      add_field => {
        "[event][kind]" => "alert"
        "[@metadata][etl][pipeline]" => "filter-mutate-5bb0f2dea084-main-suricata_corelight-20220330.01"
      }
      tag_on_failure => "_mutate_error-5bb0f2dea084-20220330.01"
      id => "filter-mutate-5bb0f2dea084"
    }

    # Do not keep tx_id / [log][id][tx_id] if it is 0
    if [log][id][tx_id] and [log][id][tx_id] == "0" {
      mutate {
        remove_field => [
          "[log][id][tx_id]"
        ] 
        add_field => {
          "[@metadata][etl][pipeline]" => "filter-mutate-b6dcf3534716-20220330.01"
        }
        tag_on_failure => "_mutate_error-b6dcf3534716-20220330.01"
        id => "filter-mutate-b6dcf3534716"
      }
    }
  }
}
